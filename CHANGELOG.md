# 更新日志 (CHANGELOG)

所有重要的项目变更都记录在此文件中。

---

## [0.9.6] - 2026-01-19

### 新增
- **统一日志系统**
  - 新增 `logger.py` 模块，替换项目中所有 `print()` 调用
  - 控制台输出 INFO 及以上级别
  - 文件日志输出 DEBUG 及以上级别 → `data/filerecorder.log`
  - 日志自动滚动（5MB × 3份备份）
  - 涉及模块：watcher、scanner、ai、ui、database、export
- **快捷键支持**
  - `Ctrl+F` - 聚焦搜索框
  - `F5` - 刷新当前视图
  - `Backspace` - 返回上级目录
  - `Alt+←/→` - 后退/前进（同鼠标侧键）
  - `Esc` - 清除搜索
  - `Ctrl+C` - 复制选中文件路径
  - `Delete` - 删除（预留功能）
  - `Shift+点击` - 范围选择
  - `Ctrl+点击` - 多选

### 重构
- **MainWindow 拆解** (代码质量优化)
  - 采用 Mixin 模式，将 2027 行"上帝类"拆分为 7 个独立模块：
    - `TrayMixin` - 系统托盘功能
    - `DatabaseMixin` - 数据库操作
    - `ExportMixin` - 导出功能
    - `NavigationMixin` - 导航/面包屑
    - `FolderTreeMixin` - 目录树
    - `ScannerMixin` - 扫描功能
    - `WatcherMixin` - 监控功能
  - MainWindow 精简至约 450 行核心代码
  - 新增 `ui/mixins/` 目录存放各 Mixin 类

### 修复
- **目录显示问题**：修复当目录下只有子目录（无文件）时，子目录在文件浏览器中不显示的问题
  - 原因：`get_folder_contents` 只查询 `folders` 表，未查询 `files` 表中的目录记录
  - 修复：额外查询 `files` 表中 `is_dir=1` 的记录并合并显示
- **根目录空文件夹问题**：修复了扫描后根目录偶尔会出现一个「名称为空」的残留文件夹的问题，通过在数据库插入及查询阶段增强校验实现
- **搜索状态残留**：修复了在清除搜索或通过侧边栏导航后，搜索高亮和「无结果」提示依然留在界面上的问题

### 优化
- **扫描启动体验**：在开始扫描前显示"正在清理旧数据"状态，解决启动时界面看似卡住的问题（实际在执行旧数据清理）
- **扫描结果显示**：在扫描进度对话框中明确区分"文件数"和"文件夹数"（例如：`已扫描: 100 个文件 | 5 个文件夹`），程序界面与日志输出保持一致
- **数据库自动优化**：移除手动"优化"按钮，扫描完成后自动执行 `ANALYZE` 更新查询优化器统计信息
- **搜索词高亮**：搜索结果中的关键词以黄色高亮显示，便于快速定位匹配内容
- **搜索体验优化**
  - 搜索无结果时显式提示「未找到相关搜索结果」，避免右侧空白导致的困惑
  - 优化搜索高亮和图标显示，修复在特定情况下（如空搜索）出现的图标错位及高亮残留问题

---

## [0.9.5] - 2026-01-17

### 新增
- **系统托盘功能**
  - 托盘图标显示（带状态指示器：🟢正常/🟡警告/🔴错误）
  - 支持最小化到系统托盘
  - 关闭行为设置（每次询问/最小化到托盘/直接退出）
  - 托盘右键菜单（显示窗口/退出）
- **索引目录选择器**（AI 整理 → 从索引选择）
  - 双栏布局：左侧目录树 + 右侧文件列表
  - 支持单击选择、双击进入，操作逻辑与系统资源管理器一致
  - 底部显示当前选中路径
- **性能优化**
  - 数据库查询优化：使用 `parent_id` 索引加速子目录查询
  - 界面列表渲染优化：固定列宽、禁用自动换行、平滑滚动
  - 图标缓存：避免每行渲染时重复获取系统图标
- **一键打包脚本**
  - 终端中运行 `build.py` 即可打包，文件储存在dist目录下
- **AI 整理HTML报告导出**：
  - 增加新的报告导出形式，支持搜索功能
- **HTML 导出**：
  - 两个导出现在均支持多关键词搜索
- **主题设置**：
  - 增加相关设置，支持浅色/深色/跟随系统

### 改进
- 设置界面新增「常规」标签页，用于配置关闭行为
- 优化文件浏览器的加载速度
- 托盘状态角标尺寸增大，更加醒目
- 更新Logo icon

### 修复
- AI 整理取消按钮：点击"取消"后正确终止任务，不生成报告和标签
- AI 整理关闭窗口：关闭窗口时立即关闭，自动终止后台任务
- 从索引选择：选择已索引目录时直接读取数据库，不再重新扫描
- HTML 导出：“大小”一列统一为左对齐
- 修复搜索功能中的带标签文件的异常高亮问题
- 修复主题为`跟随系统`时，系统主题改变后，程序主题不完全改变的问题

---

## [0.9.4] - 2026-01-16

### 新增
- **目录监控功能**
  - 启动时自动检测监控目录的变化（mtime 对比 + 文件级变化检测）
  - 本地目录实时监控（基于 watchdog 库）
  - 网络目录轮询监控（支持自定义间隔，带退避重试）
  - 静默更新模式（后台扫描不弹窗）
  - 父子目录冲突检测与合并
  - 删除索引时监控保护（三选一弹窗）
  - 状态栏显示监控状态（颜色区分：🟢正常/🟡警告/🔴错误/⚪禁用）
- **错误日志对话框**
  - 双标签页显示扫描错误和监控错误
  - 支持清除记录和导出日志

### 改进
- 轮询间隔配置持久化保存
- 优化启动检测流程，显示具体文件变化详情

---

## [0.9.3 beta-d] - 2026-01-14

### 新增
- AI 整理功能
 - 新增补充预设提示词设置标签页，不需要去配置文件中设置
 - 增加跳过样片功能开关

### 改进
- AI 整理功能
 - 优化结果输出，跳过的文件会单独计数
 - 标签管理优化，防止添加标签的时候顶替其他标签
 - ISO原盘和BDMV原盘的文件夹现在可以支持打上分类标签了
 - 暂时去除表现不佳的硬链接识别功能


---

## [0.9.3 beta-c] - 2026-01-14

### 新增
- AI 整理功能大幅优化
  - 动态标签管理（在 AI 整理弹窗中管理分类标签）
  - 二次检测机制（自动对无法通过文件名识别的文件进行上下文检测）
  - 系统额外预设提示词（`config.json` 中的 `system_preset` 字段）
  - TPM/RPM 限速配置和批次延迟
  - Temperature 参数可配置
- 报告生成优化
  - 动态分类分组（支持任意自定义标签）
  - 标准编码/无编码分组显示
  - 统一序号列

### 改进
- Prompt 优化
  - 移除硬编码类型，完全使用用户自定义标签
  - 优化编码提取规则（支持无短横格式）
  - 技术化表述减少内容审查触发（但还是建议使用审查宽松的模型来处理NSFW内容）
- 回车键冲突修复（标签输入不再触发目录选择）
- skip 和 needs_context 逻辑优化（互斥处理）

### 修复
- 修复 AI 未返回结果的文件丢失问题（自动进入二次检测）
- 修复自定义标签不生效的问题

---

## [0.9.3 beta-b] - 2026-01-13

### 修复
- 修复无法扫描的问题

---

## [0.9.3 beta-a] - 2026-01-13

### 新增
- 媒体库整理功能（AI 整理按钮）
  - 目录选择向导
  - 文件名智能解析（年份/分辨率/剧集/番号）
  - 蓝光/DVD 原盘识别
  - 硬链接检测
  - AI 辅助识别
  - Markdown 报告生成
  - 统一调用目录索引功能模块进行扫描
  - 统一使用系统扫描配置参数
- 目录索引功能（开始扫描）
  - 增加刷新按钮
  - 增加终端日志输出

### 改进
- 目录索引功能
  - 优化长文件路径支持
  - 程序扫描之后的文件计数可能和真实值不一样，因为是文件 + 目录总数，真实值不包含目录的数量
  - 优化目录树显示，提高可读性

### 修复
- 目录索引功能
  - 解决漏扫问题
  - 修复个别含俄语文件的显示问题，原调用方法可能导致文件不显示
---

## [0.9.2] - 2026-01-09

### 新增
- HTML 导出功能
  - 目录树 + 文件列表双栏界面
  - 搜索支持文件名和文件夹名
  - 表头点击排序（名称/大小/修改时间）
  - 文件夹点击跳转
  - 前进后退导航（鼠标侧键、Alt+方向键）
  - 主题切换（浅色/深色/跟随系统）
  - 底部状态栏显示当前文件夹统计和路径

### 改进
- CSV 导出添加进度弹窗
- 搜索需点击按钮或回车才执行
- 清除按钮智能返回搜索前位置

### 修复
- 修复导出 SQL 查询错误
- 修复点击箭头会切换内容的问题

---

## [0.9.1] - 2026-01-06

### 修复
- 修复 CSV/HTML 导出的数据库表名和列名错误

---

## [0.9.0] - 2026-01-05

### 新增
- CSV 导出功能
- 专用导出进度对话框

---

## [0.8.0] - 2026-01-03

### 新增
- 数据库优化（WAL 模式、批量插入）
- 扫描内存优化

---

## [0.1.0] - 初始版本

### 新增
- 基础文件扫描功能
- SQLite 数据库存储
- 多目录扫描支持
- 快速搜索
- 目录树浏览
- 数据库备份与恢复

---

## 版本说明

格式基于 [Keep a Changelog](https://keepachangelog.com/zh-CN/1.0.0/)。
